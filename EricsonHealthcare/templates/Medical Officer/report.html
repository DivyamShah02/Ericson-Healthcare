<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ericson Healthcare - Dashboard</title>

    <!-- Import BootStrap CSS Library -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Import Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Lexend:wght@100..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap">

    <!-- Import FontAwsome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Import Wow Animation CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/loader.css">

</head>

<body>
    <div id="spinner" class="spinner-container p-2">
        <div class="spinner"></div>
    </div>

    <div id="main-content" class="blur">
        <div class="px-3 px-md-5 py-3 bg-white eh-bg-blue-primary fixed-top text-white">
            <div class="d-flex justify-content-between align-items-center">
                <i class="fa fa-circle-user fa-xl"></i>
                <div class="mx-auto p-0" style="font-size: 18px;"><b>ERICSON HEALTHCARE</b></div>
                <i class="fa fa-bell fa-xl me-2"></i>
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                    <i class="fa fa-bars fa-xl"></i>
                </button>
            </div>
        </div>

        <div class="offcanvas offcanvas-end none-div" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasNavbarLabel"><b>Ericson Healthcare</b></h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div>
                    <div class="eh-menu-item p-3 py-2 mb-2 text-start" onclick="window.location.href=`{% url 'dashboard-list' %}`">
                        <i class="fa fa-home fa-md me-2"></i>Dashboard
                    </div>

                    <div class="eh-menu-item-active p-3 py-2 mb-2 text-start" onclick="window.location.href=`{% url 'reports-list' %}`">
                        <i class="fa fa-chart-line fa-md me-2"></i>Reports
                    </div>

                    <!-- <div class="eh-menu-item p-3 py-2 mb-2 text-start">
                        <i class="fa-regular fa-circle-user fa-md me-2"></i>Account
                    </div> -->
                    <hr>

                    <div class="eh-menu-item p-3 py-2 mb-2 text-start" onclick="window.location.href=`{% url 'logout-api-list' %}`">
                        <i class="fa fa-arrow-right-from-bracket fa-md me-2"></i>Log Out
                    </div>

                </div>
            </div>
        </div>

        <div class="container mt-5 pt-3">
            <div class="text-start mt-3 mb-2">
                <h3 class="eh-text-blue-primary"><b>Hello <span id="account_name"></span></b></h3>
                <small class="m-0 eh-small">Reports</small>
            </div>

            <div id="scrollable" class="dashboard-scroll-container">
                <div class="dashboard-main-card p-1 text-center" style="width: 7rem;">
                    <div class="py-4 pb-4 text-center dashboard-card">
                        <i class="fa fa-file-invoice fa-xl mb-4 eh-text-blue-primary" style="font-size: 35px;"></i>
                        <h6 class="m-0 mt-2">Total Cases</h6>
                        <h5 class="m-0 mt-2 eh-text-blue-primary"><b><span id="total_case"></span></b></h5>
                    </div>
                </div>

                <div class="dashboard-main-card p-1 text-center" style="width: 7rem;">
                    <div class="py-4 pb-4 text-center dashboard-card">
                        <i class="fa fa-file-invoice fa-xl mb-4 eh-text-blue-primary" style="font-size: 35px;"></i>
                        <h6 class="m-0 mt-2">InProgress</h6>
                        <h5 class="m-0 mt-2 eh-text-blue-primary"><b><span id="inprogress_case"></span></b></h5>
                    </div>
                </div>

                <div class="dashboard-main-card p-1 text-center" style="width: 7rem;">
                    <div class="py-4 pb-4 text-center dashboard-card">
                        <i class="fa fa-file-invoice fa-xl mb-4 eh-text-blue-primary" style="font-size: 35px;"></i>
                        <h6 class="m-0 mt-2">Closed</h6>
                        <h5 class="m-0 mt-2 eh-text-blue-primary"><b><span id="closed_case"></span></b></h5>
                    </div>
                </div>

                <div class="dashboard-main-card p-1 text-center" style="width: 7rem;">
                    <div class="py-4 pb-4 text-center dashboard-card">
                        <i class="fa fa-file-invoice fa-xl mb-4 eh-text-blue-primary" style="font-size: 35px;"></i>
                        <h6 class="m-0 mt-2">Pending</h6>
                        <h5 class="m-0 mt-2 eh-text-blue-primary"><b><span id="pending_case"></span></b></h5>
                    </div>
                </div>
            </div>

            <div class="dashboard-dots-container">
                <!-- Dots will be added dynamically -->
            </div>

            <div class="my-3 mt-4">
                <div class="row">
                    <div class="col-10 text-start">
                        <h3 class="eh-text-blue-primary" id="report_role"><b> Details</b></h3>
                    </div>
                    <div class="col-2 text-end">
                        <div class="dropdown">
                            <button type="button" class="btn p-0" data-bs-toggle="dropdown">
                                <i class="fa fa-ellipsis-vertical" style="color: #000;"></i>
                            </button>                
                            <div class="dropdown-menu dropdown-menu-start" aria-labelledby="transactionID">
                                <a class="dropdown-item" onclick="GetReportDetails('medical_officer')">Medical officer</a>
                                <a class="dropdown-item" onclick="GetReportDetails('data_entry_personnel')">Data entry personnel</a>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="table-responsive">
                    <table class="table table-bordered text-center">
                        <thead class="table-light align-top">
                            <tr>
                                <th scope="col">Sr. No.</th>
                                <th scope="col">Name</th>
                                <th scope="col">Total Cases</th>
                                <th scope="col">InProgress Cases</th>
                                <th scope="col">Pending Cases</th>
                                <th scope="col">Closed Cases</th>
                                
                            </tr>
                        </thead>
                        <tbody id="report_table">
                            <tr class="align-middle">
                                <td>1</td>
                                <td>Divyam Shah</td>
                                <td>10</td>
                                <td>4</td>
                                <td>3</td>
                                <td>3</td>
                            </tr>    
                            <tr>
                                <td>2</td>
                                <td>Divyam Shah</td>
                                <td>10</td>
                                <td>4</td>
                                <td>3</td>
                                <td>3</td>
                            </tr>        
                        </tbody>
                    </table>
                </div>

                <!-- Button trigger modal -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userLevelReport" id="userLevelReportButton" style="display: none;">
                    User level Report
                </button>

                <!-- Modal -->
                <div class="modal fade" id="userLevelReport" tabindex="-1" aria-labelledby="userLevelReportLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h1 class="modal-title fs-5" id="userLevelReportLabel">Divyam Shah's Report</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-bordered text-center">
                                    <thead class="table-light align-top">
                                        <tr>
                                            <th scope="col">Sr. No.</th>
                                            <th scope="col">Case Number</th>
                                            <th scope="col">Case Closed</th>
                                            <th scope="col">TAT</th>
                                            <th scope="col">TAT Achieved</th>
                                            
                                        </tr>
                                    </thead>
                                    <tbody id="user_level_report_table">
                                        <tr class="align-middle">
                                            <td>1</td>
                                            <td>1002</td>
                                            <td><i class="fa fa-check text-success"></i></td>
                                            <td>4</td>
                                            <td><i class="fa fa-check text-success"></i></td>
                                        </tr>          
                                    </tbody>
                                </table>
                            </div>
            
                        </div>
                        <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>                        
                    </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Import BootStrap JavaScript Library -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <!-- Import Wow Animation JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>

    <script src="/static/js/loader.js"></script>
    <script src="/static/js/api_caller.js"></script>

    <script>
        window.onload = function () {
            GetDashboardDetails();
            GetReportDetails("data_entry_personnel");
            toggle_loader();
        };
    </script>

    <script>
        let UserData = {};

        async function GetDashboardDetails() {
            
            const url = "{% url 'dashboard-api-list' %}";
            const [success, result] = await callApi("POST", url, null, "{{csrf_token}}");
            console.log(result);

            if (success) {
                if (result.success){
                    UserData = result.data;

                    document.getElementById('account_name').innerText = UserData.name;

                    const validRoles = ['admin', 'hod', 'coordinator'];
                    if (validRoles.includes(UserData.role)) {
                        // document.getElementById('add_case_btn').style.display = '';

                        if (UserData.role == 'hod'){
                            // document.getElementById('coordinator_select_div').style.display = '';
                            // await getCoordinatorDetails();
                        }

                    }
                    

                }

                else {
                    window.location.href=`{% url 'login-list' %}`;
                }

            } else {
                window.location.href=`{% url 'login-list' %}`;

            }
        }

        async function GetReportDetails(report_role) {
            document.getElementById('report_role').innerText = report_role.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()) + " Details";
            document.getElementById('report_table').innerHTML = '';
            
            const url = "{% url 'get-report-info-api-list' %}";
            let bodyData = {
                report_role: report_role
            };
            const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");

            if (success) {
                if (result.success){
                    let report_user_data = result.data;
                    let total_cases = 0;
                    let in_progress_cases = 0;
                    let pending_cases = 0;
                    let closed_cases = 0;

                    report_user_data.users.forEach(async (user, index) => {
                        let user_case_details = await getCaseList(user.user_id);
                        let row = `<tr>
                            <td>${index + 1}</td>
                            <td onclick="handle_user_level_report('${user.name}', '${user.user_id}')"><u>${user.name}</u></td>
                            <td>${user_case_details.data.total_cases}</td>
                            <td>${user_case_details.data.in_progress_cases}</td>
                            <td>${user_case_details.data.pending_cases}</td>
                            <td>${user_case_details.data.closed_cases}</td>
                        </tr>`;

                        document.getElementById('report_table').innerHTML += row;

                        total_cases += user_case_details.data.total_cases;
                        in_progress_cases += user_case_details.data.in_progress_cases;
                        pending_cases += user_case_details.data.pending_cases;
                        closed_cases += user_case_details.data.closed_cases;

                        document.getElementById('total_case').innerText = total_cases;
                        document.getElementById('inprogress_case').innerText = in_progress_cases;
                        document.getElementById('closed_case').innerText = pending_cases;
                        document.getElementById('pending_case').innerText = closed_cases;
                    });
                }

                else {
                    window.location.href=`{% url 'reports-list' %}`;
                }

            } else {
                window.location.href=`{% url 'reports-list' %}`;

            }
        }

        async function getCaseList(custom_user) {
            const getUserParams = {
                custom_user: custom_user,
            };

            const url = "{% url 'get-all-case-api-list' %}?" + toQueryString(getUserParams); // Construct the full URL with query params
            const [success, result] = await callApi("GET", url);
            if (success) {
                if (result.success) {
                    return result;
                }
                else {
                    document.getElementById('error-in-displaying-cases').style.display = '';
                }
            } else {
                document.getElementById('error-in-displaying-cases').style.display = '';
                
            }
        }

        async function handle_user_level_report(user_name, user_id) {
            document.getElementById('user_level_report_table').innerHTML = '';
            document.getElementById('userLevelReportLabel').innerText = user_name + "'s Report";
            let user_case_details = await getCaseList(user_id);
            console.log(user_case_details);
            user_case_details.data.case_data.forEach(async (case_data, index) => {
                let row = `<tr>
                    <td>${index + 1}</td>`
                    if (case_data.claim_number != '') {
                        row += `<td>${case_data.claim_number}</td>`;
                    }
                    else {
                        row += `<td>${case_data.case_id}</td>`;
                    }
                    if (case_data.case_status === 'Complete') {
                        row += `<td><i class="fa fa-check text-success"></i></td>`;
                    }
                    else {
                        row += `<td><i class="fa fa-times text-danger"></i></td>`;
                    }

                    row += `<td>4</td>
                    <td><i class="fa fa-check text-success"></i></td>`

                row += `</tr>`;

                document.getElementById('user_level_report_table').innerHTML += row;
            });
            
            document.getElementById('userLevelReportButton').click();
        }

    </script>

<script>
    const scrollable = document.getElementById('scrollable');
    const dotsContainer = document.querySelector('.dashboard-dots-container');
    const cards = document.querySelectorAll('.dashboard-main-card');

    // Create dots based on the number of cards
    cards.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.classList.add('dashboard-dot');
        if (index === 0) dot.classList.add('active');
        dotsContainer.appendChild(dot);
    });

    const dots = document.querySelectorAll('.dashboard-dot');

    // Update dots on scroll
    scrollable.addEventListener('scroll', () => {
        const scrollLeft = scrollable.scrollLeft;
        const scrollWidth = scrollable.scrollWidth - scrollable.clientWidth;

        // Calculate the active dot
        const activeIndex = Math.round(
            (scrollLeft / scrollWidth) * (dots.length - 1)
        );

        dots.forEach((dot, index) => {
            if (index === activeIndex) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        });
    });
</script>

</body>

</html>
