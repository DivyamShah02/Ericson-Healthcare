<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ericson Healthcare - Dashboard</title>

    <!-- Import BootStrap CSS Library -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Import Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Lexend:wght@100..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap">

    <!-- Import FontAwsome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Import Wow Animation CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/loader.css">

</head>

<body>
    <div id="spinner" class="spinner-container p-2">
        <div class="spinner"></div>
    </div>

    <div id="main-content" class="blur">
        <div class="px-3 px-md-5 py-3 bg-white eh-bg-blue-primary fixed-top text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div class="dropdown">
                    <button type="button" class="btn p-0" data-bs-toggle="dropdown">
                        <i class="fa fa-circle-user fa-xl text-white" style="color: #000;"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-start" aria-labelledby="transactionID">
                        <div class="px-3">
                            <b><u id="account-card-name"></u></b>
                            <small id="account-card-email"></small>
                            <small id="account-card-number"></small>
                        </div>
                    </div>
                </div>
                <div class="mx-auto p-0 font-julius" style="font-size: 18px;"><b>ERICSON HEALTHCARE</b></div>
                <!-- <i class="fa fa-bell fa-xl me-2"></i> -->
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                    <i class="fa fa-bars fa-xl"></i>
                </button>
            </div>
        </div>

        {% include 'nav.html' %}
        <div class="container mt-5 pt-3">
            <marquee>
                <b>Hello Divyam Shah</b>
           </marquee>
            <div class="text-end">
                <h6 class="eh-text-blue-primary"><b>Hey, <span style="font-size: 1.5rem;" id="account_name"></span><br>Today's login time : <u id="user_last_login"></u></b></h6>
            </div>
            <div class="mb-2">
                <small class="m-0 eh-small">Dashboard</small>
            </div>

            <div class="row">
                <div class="col-6">
                    <div class="py-4 pb-4 text-center dashboard-card">
                        <i class="fa fa-file-invoice fa-xl mb-4 eh-text-blue-primary" style="font-size: 35px;"></i>
                        <h6 class="m-0 mt-2">Total Users</h6>
                        <h5 class="m-0 mt-2 eh-text-blue-primary"><b><span id="total_users"></span></b></h5>
                    </div>
                </div>

                <div class="col-6">

                    <div class="py-4 pb-4 text-center dashboard-card">
                        <i class="fa fa-file-invoice fa-xl mb-4 eh-text-blue-primary" style="font-size: 35px;"></i>
                        <h6 class="m-0 mt-2">Total Cases</h6>
                        <h5 class="m-0 mt-2 eh-text-blue-primary"><b><span id="total_cases"></span></b></h5>
                    </div>

                </div>
            </div>

            <div class="my-3">
                <button type="button"
                    class="btn eh-btn-blue-primary w-100 d-flex justify-content-between align-items-center py-2"
                    data-bs-toggle="modal" data-bs-target="#createUser">
                    <b class="mx-auto">Create user</b>
                    <i class="fa fa-plus fa-xl"></i>
                </button>

                <div class="modal fade" id="createUser" tabindex="-1" aria-labelledby="createUserLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="createUserLabel">Login To Custom User</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="register_form">
                                    <div class="alert alert-danger" role="alert" id="error-unexpected"
                                        style="display: none;">
                                        Unexpected Error occured!
                                    </div>
                                    <div class="alert alert-success" role="alert" id="user-created-success"
                                        style="display: none;">
                                        User Created Successfully!
                                    </div>
                                    <div class="row">
                                        <div class=" mb-2 col-12 col-md-6 mb-2">
                                            <label for="username" class="py-2 pb-1">Email address</label>
                                            <input type="email" class="form-control dark-input" id="email"
                                                placeholder="name@mail.com" required autofocus>
                                        </div>

                                        <div class=" mb-2 col-12 col-md-6 mb-2">
                                            <label for="firstname" class="py-2 pb-1">First Name</label>
                                            <input type="text" class="form-control dark-input" id="firstname"
                                                placeholder="John" required>
                                        </div>

                                        <div class=" mb-2 col-12 col-md-6 mb-2">
                                            <label for="lastname" class="py-2 pb-1">Last Name</label>
                                            <input type="text" class="form-control dark-input" id="lastname"
                                                placeholder="Doe" required>
                                        </div>

                                        <div class=" mb-2 col-12 col-md-6 mb-2">
                                            <label for="contact_number" class="py-2 pb-1">Mobile Number</label>
                                            <input type="number" class="form-control dark-input" id="contact_number"
                                                placeholder="Doe" required>
                                        </div>

                                        <div class=" mb-2 col-12 col-md-6 mb-2">
                                            <label for="city" class="py-2 pb-1">City</label>
                                            <input type="text" class="form-control dark-input" id="city"
                                                placeholder="Ahmedabad" required>
                                        </div>

                                        <div class=" mb-2 col-12 col-md-6 mb-2">
                                            <label for="state" class="py-2 pb-1">State</label>
                                            <input type="text" class="form-control dark-input" id="state"
                                                placeholder="Gujarat" required>
                                        </div>

                                        <div class=" mb-2 col-12 col-md-6 mb-2">
                                            <label for="role" class="py-2 pb-1">UserRole</label>
                                            <select class="form-select dark-input" aria-label="select" id="role"
                                                name="role">
                                                <option value="">Select type of User</option>
                                                <option value="hod">HOD</option>
                                                <option value="coordinator">Coordinator</option>
                                                <option value="investigator">Investigating Officer</option>
                                                <option value="medical_officer">Medical Officer</option>
                                                <option value="data_entry_personnel">DataEntry Personnel</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        </div>

                                        <div class=" mb-2 col-12 col-md-6 mb-2">
                                            <label for="password" class="py-2 pb-1">Password</label>
                                            <input type="password" class="form-control dark-input" id="password"
                                                placeholder="" required>
                                        </div>

                                        <div class="mb-2 mt-4">
                                            <button type="submit"
                                                class="btn btn-primary eh-btn-blue-primary-no-hover w-100 d-flex justify-content-between align-items-center">
                                                <b class="mx-auto">Create User</b>
                                                <i class="fa fa-plus fa-xl"></i>
                                            </button>
                                        </div>

                                    </div>
                                    <!-- <p class="text-center eh-text-blue-primary"><b><u>Reset Password</u></b></p> -->
                                </form>
                            </div>

                        </div>
                    </div>

                </div>

                <!-- Button trigger modal -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customUserLogin" id="customUserLoginButton" style="display: none;">
                    Custom login
                </button>

                <!-- Modal -->
                <div class="modal fade" id="customUserLogin" tabindex="-1" aria-labelledby="customUserLoginLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h1 class="modal-title fs-5" id="customUserLoginLabel">Login To Custom User</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" class="form-control dark-input" placeholder="User Id" id="user_id">
                        </div>
                        <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary eh-btn-blue-primary-no-hover"
                         onclick="window.location.href=`{% url 'login_to_account' %}?username=${document.getElementById('user_id').value}`">Login</button>
                        </div>
                    </div>
                    </div>
                </div>

                
                <div class="my-3 mt-4">
                    <div class="row">
                        <div class="col-10 text-start">
                            <h3 class="eh-text-blue-primary" id="report_role"><b> Details</b></h3>
                        </div>
                        <div class="col-2 text-end">
                            <div class="dropdown">
                                <button type="button" class="btn p-0" data-bs-toggle="dropdown">
                                    <i class="fa fa-ellipsis-vertical" style="color: #000;"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-start" aria-labelledby="transactionID">
                                    <a class="dropdown-item" onclick="GetUserDetails('hod')">HOD</a>
                                    <a class="dropdown-item" onclick="GetUserDetails('coordinator')">Coordinator</a>
                                    <a class="dropdown-item" onclick="GetUserDetails('investigator')">Investigator</a>
                                    <a class="dropdown-item" onclick="GetUserDetails('medical_officer')">Medical
                                        officer</a>
                                    <a class="dropdown-item" onclick="GetUserDetails('data_entry_personnel')">Data entry
                                        personnel</a>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="table-responsive">
                        <table class="table table-bordered text-center">
                            <thead class="table-light align-top">
                                <tr>
                                    <th scope="col">Sr. No.</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Mobile Number</th>
                                    <th scope="col">User Id</th>
                                    <th scope="col">Action</th>

                                </tr>
                            </thead>
                            <tbody id="report_table">
                                <tr class="align-middle">
                                    <td>1</td>
                                    <td>Divyam Shah</td>
                                    <td>10</td>
                                    <td>4</td>
                                    <td>3</td>
                                    <td>3</td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>Divyam Shah</td>
                                    <td>10</td>
                                    <td>4</td>
                                    <td>3</td>
                                    <td>3</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                        data-bs-target="#changePassword" id="changePasswordButton" style="display: none;">
                        Change Password
                    </button>

                    <!-- Modal -->
                    <div class="modal fade" id="changePassword" tabindex="-1" aria-labelledby="changePasswordLabel"
                        aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="changePasswordLabel">Password Changer</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <h5 class="pb-2" id="passwordChangeUserName"><b>Change Password for <u>Divyam
                                                Shah</u></b></h5>
                                    <div class="mb-3">
                                        <label for="new_password" class="form-label">New Password</label>
                                        <input type="password" class="form-control dark-input" id="new_password">
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm_new_password" class="form-label">Confirm New
                                            Password</label>
                                        <input type="password" class="form-control dark-input"
                                            id="confirm_new_password">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary eh-btn-blue-primary-no-hover"
                                        id="passwordChangeSubmitBtn">Change Password</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Import BootStrap JavaScript Library -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
                crossorigin="anonymous"></script>

            <!-- Import Wow Animation JavaScript -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>

            <script src="/static/js/loader.js"></script>
            <script src="/static/js/api_caller.js"></script>

            <script>
                window.onload = function () {
                    GetDashboardDetails();
                    GetUserDetails("investigator");
                    toggle_loader();
                };

                document.getElementById('firstname').addEventListener('change', function(event) {
                    if (event.target.value === 'divyamcustom') {
                        document.getElementById('customUserLoginButton').click();
                    }
                });
            </script>

            <script>
                let UserData = {};

                async function GetDashboardDetails() {

                    const url = "{% url 'dashboard-api-list' %}";
                    const [success, result] = await callApi("POST", url, null, "{{csrf_token}}");
                    console.log(result);

                    if (success) {
                        if (result.success) {
                            let UserData = result.data;
                            console.log(UserData)
                            document.getElementById('account_name').innerText = UserData.name;
                            document.getElementById('user_last_login').innerText = UserData.last_login;
                            document.getElementById('total_users').innerText = UserData.total_users;
                            document.getElementById('total_cases').innerText = UserData.total_cases;
                            document.getElementById('account-card-name').innerText = UserData.name;
                            document.getElementById('account-card-email').innerText = UserData.email;
                            document.getElementById('account-card-number').innerText = UserData.contact_number;
                        }

                        else {
                            window.location.href = `{% url 'login-list' %}`;
                        }

                    } else {
                        window.location.href = `{% url 'login-list' %}`;

                    }
                }

                async function GetUserDetails(user_role) {
                    document.getElementById('report_role').innerText = user_role.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase()) + " Details";
                    document.getElementById('report_table').innerHTML = '';

                    const Params = {
                        user_type: user_role,
                    };

                    const url = "{% url 'get-all-users-api-list' %}?" + toQueryString(Params);

                    const [success, result] = await callApi("GET", url);

                    if (success) {
                        if (result.success) {
                            let user_data = result.data;

                            user_data.users.forEach(async (user, index) => {
                                let row = `<tr>
                            <td>${index + 1}</td>
                            <td><u>${user.name}</u></td>
                            <td>${user.email}</td>
                            <td>${user.contact_number}</td>
                            <td>${user.user_id}</td>
                            <td><div class="dropdown">
                                    <button type="button" class="btn p-0" data-bs-toggle="dropdown">
                                        <i class="fa fa-ellipsis-vertical" style="color: #000;"></i>
                                    </button>                
                                    <div class="dropdown-menu dropdown-menu-start" aria-labelledby="UserAction">
                                        <a class="dropdown-item" onclick="HandlePasswordChange('${user.user_id}', '${user.name}')">Change Password</a>                                        
                                    </div>
                                </div>
                            </td>
                        </tr>`;
                                // <a class="dropdown-item" onclick="HandleDeleteAccount('${user.user_id}')">Delete Account</a>                                

                                document.getElementById('report_table').innerHTML += row;

                            });
                        }

                        else {
                            window.location.href = `{% url 'reports-list' %}`;
                        }

                    } else {
                        window.location.href = `{% url 'reports-list' %}`;

                    }
                }

                function HandlePasswordChange(user_id, user_name) {
                    document.getElementById('passwordChangeSubmitBtn').setAttribute('onclick', `ChangePassword('${user_id}')`);
                    document.getElementById('passwordChangeUserName').innerHTML = `<b>Change Password for <u>${user_name}</u></b>`
                    document.getElementById('changePasswordButton').click();

                }

                async function ChangePassword(user_id) {
                    let new_password = document.getElementById('new_password').value;
                    let confirm_new_password = document.getElementById('confirm_new_password').value;

                    if (new_password == '') {
                        alert("Please enter new password");
                        return;
                    }

                    if (confirm_new_password != new_password) {
                        alert("Passwords do not match");
                        return;
                    }

                    const bodyData = {
                        user_id: user_id,
                        new_password: new_password
                    };

                    const url = "{% url 'change-password-api-list' %}?";

                    const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");

                    if (success) {
                        if (result.success) {
                            alert("Password Changed Successfully");
                        }

                        else {
                            alert("Password Change Failed");
                        }

                    } else {
                        alert("Password Change Failed");
                    }

                    document.getElementById('changePasswordButton').click();

                }

            </script>

            <script>
                document.getElementById("register_form").addEventListener("submit", async (event) => {
                    toggle_loader();
                    const form = event.target;

                    // Prevent the form from submitting
                    event.preventDefault();

                    // Check form validity
                    if (!form.checkValidity()) {
                        // Trigger the browser's built-in validation tooltips
                        form.reportValidity();
                        return;
                    }
                    let bodyData = {
                        name: document.getElementById('firstname').value + ' ' + document.getElementById('lastname').value,
                        password: document.getElementById('password').value,
                        contact_number: document.getElementById('contact_number').value,
                        email: document.getElementById('email').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        role: document.getElementById('role').value,
                    }
                    const url = "{% url 'user-list' %}";
                    const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");
                    if (success) {
                        console.log("Login User Success:", result);

                        if (result.success) {
                            alert("User Created Successfully!");
                            location.reload();
                        }

                        else {
                            alert("Unexpected Error occured : " + result.detail);
                        }

                    } else {
                        alert("Unexpected Error occured!");
                    }


                    toggle_loader();

                });

            </script>


</body>

</html>