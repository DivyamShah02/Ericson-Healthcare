<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ericson Healthcare</title>

    <!-- Import BootStrap CSS Library -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Import Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Lexend:wght@100..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap">

    <!-- Import FontAwsome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Import Wow Animation CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

    <!-- Import the official PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/loader.css">

</head>

<body>
    <div id="spinner" class="spinner-container p-2">
        <div class="spinner"></div>
        <img src="/static/logo.png" alt="Logo" class="spinner-logo">
        <!-- <div id="spinner-text" class="loading-text text-center">loading!</div> -->
    </div>

    <div id="main-content" class="blur">
        <div class="px-3 px-md-5 py-3 bg-white eh-bg-blue-primary fixed-top text-white">
            <div class="d-flex justify-content-between align-items-center">
                <i class="fa fa-chevron-left fa-xl" onclick="window.location.href=`{% url 'dashboard-list' %}`;"></i>
                <div class="mx-auto p-0" style="font-size: 18px;"><b id="case_id_text">Case #</b></div>
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                    <i class="fa fa-bars fa-xl"></i>
                </button>
            </div>
        </div>

{% include 'nav.html' %}
        <!-- Process Step Section -->
        <div class="container py-4 pt-4 mt-5">
            <h1 id="step-name" class="eh-text-blue-primary"></h1>
            <div class="">
                <div class="row p-3 pb-0" id="step-1" style="display: none;">
                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            &nbsp;&nbsp;&nbsp;
                            <!-- <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i> -->
                            <i class="fa fa-circle-dot fa-sm eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-2 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-3 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-4 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-5 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <!-- <div class="eh-progress-bar-line"></div> -->
                        </div>
                    </div>
                </div>

                <div class="row p-3 pb-0" id="step-2" style="display: none;">
                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            &nbsp;&nbsp;&nbsp;
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-dot fa-sm eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-3 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-4 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-5 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <!-- <div class="eh-progress-bar-line"></div> -->
                        </div>
                    </div>
                </div>

                <div class="row p-3 pb-0" id="step-3" style="display: none;">
                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            &nbsp;&nbsp;&nbsp;
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-dot fa-sm eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-4 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-5 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <!-- <div class="eh-progress-bar-line"></div> -->
                        </div>
                    </div>
                </div>

                <div class="row p-3 pb-0" id="step-4" style="display: none;">
                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            &nbsp;&nbsp;&nbsp;
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-dot fa-sm eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-5 fa-sm eh-progress-bar-icon-incomplete"></i>
                            <!-- <div class="eh-progress-bar-line"></div> -->
                        </div>
                    </div>
                </div>

                <div class="row p-3 pb-0" id="step-5" style="display: none;">
                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            &nbsp;&nbsp;&nbsp;
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-dot fa-sm eh-progress-bar-icon"></i>
                            <!-- <div class="eh-progress-bar-line"></div> -->
                        </div>
                    </div>
                </div>

                <div class="row p-3 pb-0" id="step-6" style="display: none;">
                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            &nbsp;&nbsp;&nbsp;
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <div class="eh-progress-bar-line-completed"></div>
                        </div>
                    </div>

                    <div class="col p-0 m-0 text-center">
                        <div class="eh-progress-bar mb-3">
                            <i class="fa fa-circle-check fa-xl eh-progress-bar-icon"></i>
                            <!-- <div class="eh-progress-bar-line"></div> -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <section>
            <div class="container">
                <ul class="nav nav-underline mb-3 row" id="case-tab" role="tablist">
                    <li class="nav-item col text-center" role="presentation">
                        <a class="nav-link eh-nav-link-case-coordinator active" id="visits-tab" data-bs-toggle="pill"
                            data-bs-target="#visits" role="tab" aria-controls="visits" aria-selected="true">Case Overview</a>
                    </li>
                    <li class="nav-item col text-center" role="presentation">
                        <a class="nav-link eh-nav-link-case-coordinator" id="documents-tab" data-bs-toggle="pill"
                            data-bs-target="#documents" role="tab" aria-controls="documents"
                            aria-selected="false">Documents</a>
                    </li>
                    <!-- <li class="nav-item col text-center" role="presentation">
                      <a class="nav-link eh-nav-link-case-coordinator" id="reports-tab" data-bs-toggle="pill" data-bs-target="#reports" role="tab" aria-controls="reports" aria-selected="false">Reports</a>
                    </li> -->
                </ul>
                <div class="tab-content" id="case-tabContent">
                    <div class="tab-pane fade show active" id="visits" role="tabpanel" aria-labelledby="visits-tab" tabindex="0">                
                        <h3 class="eh-head">Case Details</h3>
                        <div class="row mb-4">
                            
                                <div class="col-6 text-start eh-key pe-0 pe-md-2">Case Id</div>
                                <div class="col-6 text-end text-lg-start eh-value ps-0 ps-md-2" id="case_details_case_id"></div>
                                <div class="col-12 px-3">
                                    <hr class="p-0 my-1 visit-card-eh-hr">
                                </div>                            

                            
                                <div class="col-6 text-start eh-key pe-0 pe-md-2">Insurance Company</div>
                                <div class="col-6 text-end text-lg-start eh-value ps-0 ps-md-2" id="case_details_insaurance_company"></div>
                                <div class="col-12 px-3">
                                    <hr class="p-0 my-1 visit-card-eh-hr">
                                </div>                            

                            
                                <div class="col-6 text-start eh-key pe-0 pe-md-2">Case Type</div>
                                <div class="col-6 text-end text-lg-start eh-value ps-0 ps-md-2" id="case_details_type_of_case"></div>
                                <div class="col-12 px-3">
                                    <hr class="p-0 my-1 visit-card-eh-hr">
                                </div>                            

                            
                                <div class="col-6 text-start eh-key pe-0 pe-md-2">Diagnosis</div>
                                <div class="col-6 text-end text-lg-start eh-value ps-0 ps-md-2" id="case_details_diagnosis"></div>
                                <div class="col-12 px-3">
                                    <hr class="p-0 my-1 visit-card-eh-hr">
                                </div>                            
                            
                        </div>
                        
                        <h3 class="eh-head">Visits Details</h3>

                        <button class="btn eh-btn-blue-primary-outline w-100 py-2" type="button" id="addVisitBtn" onclick="defaultVisitModal()" style="display: none;"><b>Add Visit</b></button>

                        <button style="display: none;" id="addVisitBtnModal" data-bs-toggle="modal"
                        data-bs-target="#addVisitModal"></button>

                        <!-- Modal -->
                        <div class="modal fade" id="addVisitModal" tabindex="-1" aria-labelledby="addVisitModalLabel"
                            aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5" id="addVisitModalLabel">Add Visit</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form action="" id="add_visit_form">
                                            <input type="hidden" name="edit_visit_id" id="edit_visit_id">
                                            <div class="mb-3">
                                                <label for="type_of_visit" class="form-label eh-label">Type of
                                                    visit</label>
                                                <select class="form-select dark-input" aria-label="select"
                                                    onchange="handleOptionChange()" id="type_of_visit" name="type_of_visit">
                                                    <option value="default">Select type of visit</option>
                                                    <option value="Hospital">Hospital</option>
                                                    <!-- <option value="Treating_doctor">Treating Doctor</option> -->
                                                    <option value="Lab">Lab</option>
                                                    <option value="Chemist">Chemist</option>
                                                    <option value="Insured">Insured</option>
                                                </select>
                                            </div>
                                            <div id="add_visit_form_inputs"></div>
                                            <div class="mb-3">
                                                <label for="investigator_select"
                                                    class="form-label eh-label">Investigator Officer</label>
                                                <select class="form-select dark-input" aria-label="select"
                                                    id="investigator_select" name="investigator_id">
                                                    <option value="">Select Investigator Officer</option>
                                                    
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="" class="form-label eh-label">Questions</label>
                                                <div class="select-question-card p-2">
                                                    <div class="d-flex" style="cursor: pointer;"
                                                        onclick="toggleAddQuestions()">
                                                        <div class="col text-start">
                                                            <label for="" class="form-label eh-label m-0">Select
                                                                Questions</label>
                                                        </div>
                                                        <div class="col text-end">
                                                            <i class="fa fa-chevron-down" id="add-question-icon"></i>
                                                        </div>
                                                    </div>
                                                    <div id="questions-list" class="mt-2" style="display: none;">
                                                        <!-- <div class="form-check">
                                                            <input class="form-check-input" type="checkbox"
                                                                id="question1" name="question1"
                                                                value="option1">
                                                            <label class="form-check-label"
                                                                for="question1">Checkbox 1</label>
                                                        </div>
                                                         -->
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn eh-btn-blue-primary" onclick="createNewVisit()">Save changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="visit-cards">
                            <div class="my-3">
                                <div class="p-5 text-center dark-input" id="no-visit-created"
                                  style="border-radius: 10px; background-color: var(--eh-danger);">
                                  <i class="fa fa-triangle-exclamation fa-xl eh-text-blue-primary" style="font-size: 2.5rem;"></i>
                                  <p class="p-0 m-0 mt-2 eh-text-blue-primary"><b>0 Visit created for this case</b></p>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab"
                        tabindex="0">
                        <h3 class="eh-head my-3">Case Documents</h3>
                        <label class="btn btn-primary eh-btn-blue-primary-no-hover w-100 py-2 mb-3"><b>Upload
                                Document</b>
                                <input type="file" id="addDocumentInput" hidden accept=".mp3, .wav, .ogg, .mp4, .webm, .jpg, .jpeg, .png, .gif, .webp, .pdf">
                        </label>
                        <div id="document_list_div">
                            <!-- <div class="d-flex align-items-center py-3 px-2 mb-2 document-card" onclick="openDocModal('https://pdfobject.com/pdf/sample.pdf', 'sample.pdf')">
                                <i class="fa fa-file-pdf fa-xl"></i>&nbsp;&nbsp;&nbsp; <u>sample.pdf</u>
                                <div class="ms-auto"><i class="fa fa-download fa-xl mx-2"></i></div>
                            </div> -->
                        </div>

                        <!-- Modal -->
                        <div class="modal fade" id="viewDocumentModal" tabindex="-1"
                            aria-labelledby="viewDocumentModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title fs-5 text-wrap text-break" id="viewDocumentModalLabel">View Document</h1>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div id="document-viewer" class="viewer"></div>
                                        <!-- <div id="pdf-viewer-container" class="pdf-viewer-container">
                                            <canvas id="pdf-renderer"></canvas>
                                        </div> -->
                                        <!-- <iframe src="/media/uploads/suit_divyam(1).jpeg" width="100%" height="500px" id="viewDocumentModalIframe"
                                            style="border: none;"></iframe> -->
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab" tabindex="0">
                        ...
                    </div>
                </div>

                <div class="mb-5 pb-5"></div>

                <div class="fixed-bottom mb-2 mx-2 mx-md-5 px-md-5">
                    <div class="row">
                        <div class="col-12 col-md-6">
                            <button type="button" onclick="updateCaseStatus('Creation_confirmation')"
                                class="btn btn-primary mb-2 eh-btn-blue-primary-no-hover w-100 d-flex justify-content-between align-items-center">
                                <i class="fa fa-arrow-left fa-xl"></i>
                                <b class="mx-auto">Edit Case Details</b>
                            </button>
                        </div>
                        <div class="col-12 col-md-6">
                            <button type="button" onclick="updateCaseStatus('Medical')" id="send_case_to_medical_officer"
                                class="btn btn-primary mb-md-2 eh-btn-blue-primary-no-hover w-100 d-flex justify-content-between align-items-center">
                                <b class="mx-auto">Send Case to Medical Officer</b>
                                <i class="fa fa-arrow-right fa-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- Import BootStrap JavaScript Library -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <!-- Import Wow Animation JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.min.js"></script>

    <script src="/static/js/process-step.js"></script>
    <script src="/static/js/loader.js"></script>
    <script src="/static/js/api_caller.js"></script>
    <script src="/static/js/script.js"></script>

    <script>
        new WOW().init();

        const caseId = new URLSearchParams(window.location.search).get('case_id');
        const document_tab = new URLSearchParams(window.location.search).get('document_tab');
        console.log(document_tab);

        if (document_tab == 'true') {
            document.getElementById('documents-tab').click();
        }

        window.onload = function () {
            getCaseDetails();
            getCaseData();
            getVistDetails();
            getInvestigatorDetails();
            getQuestions();
            toggle_loader();
        };
        processStep(2);

    </script>

    <script>
        async function getCaseData() {
            const Params = {
                case_id: caseId,
            };

            const url = "{% url 'case-api-list' %}?" + toQueryString(Params); // Construct the full URL with query params
            const [success, result] = await callApi("GET", url);
            console.log(result);
            if (success) {
                if (result.success) {
                    console.log(result.data.all_docs);
                    if (result.data.claim_number != '') {
                        document.getElementById('case_id_text').innerText = `Case #${result.data.claim_number}`;
                    } else {
                        document.getElementById('case_id_text').innerText = `Case #${result.data.case_id}`;
                    }
                    if (result.data.case_status == 'Creation_confirmation') {
                        document.getElementById('visits-tab').click();
                    }
                    createDocumentList(result.data.all_docs);
                }
                else {
                    window.location.href=`{% url 'dashboard-list' %}`;
                }
            } else {
                window.location.href=`{% url 'dashboard-list' %}`;
            }
        }

        async function getCaseDetails() {
            const Params = {
                case_id: caseId,
            };

            const url = "{% url 'case-details-api-list' %}?" + toQueryString(Params);
            const [success, result] = await callApi("GET", url);
            console.log(result);
            if (success) {
                if (result.success) {
                    visit_type = result.data.type_of_case;
                    document.getElementById('case_details_case_id').innerText = result.data.case_id;
                    document.getElementById('case_details_insaurance_company').innerText = result.data.insurance_company;
                    document.getElementById('case_details_type_of_case').innerText = addSpaces(result.data.type_of_case);
                    document.getElementById('case_details_diagnosis').innerText = result.data.diagnosis;
                }
                else {
                    window.location.href=`{% url 'dashboard-list' %}`;
                }
            } else {
                window.location.href=`{% url 'dashboard-list' %}`;
            }
        }

    </script>

    <!-- // Handle Visit related functions -->
    <script>
        let visit_type = '';
        function toggleCard(card) {
            let card_id = card.id;
            let card_detial_id = `${card_id}-detail`;
            let card_icon_id = `${card_id}-icon`;
            let card_details_ele = document.getElementById(card_detial_id);
            console.log(card_detial_id);
            if (card_details_ele.style.display == 'none') {
                card_details_ele.style.display = 'block';
                document.getElementById(card_icon_id).classList.remove('fa-plus');
                document.getElementById(card_icon_id).classList.add('fa-minus');
            }
            else {
                card_details_ele.style.display = 'none';
                document.getElementById(card_icon_id).classList.remove('fa-minus');
                document.getElementById(card_icon_id).classList.add('fa-plus');
            }
        }

        function handleOptionChange() {
            const select = document.getElementById('type_of_visit');
            const selectedValue = select.value;

            if (selectedValue === 'Hospital') {
                createHospitalFormInput();
                handle_hospital();
            }

            if (selectedValue === 'Lab') {
                createLabFormInput();
            }

            if (selectedValue === 'Chemist') {
                createChemistFormInput();
            }

            if (selectedValue === 'Insured') {
                createInsuredFormInput();
            }


            if (selectedValue === 'default') {
                deleteElementsWithIdPrefix('type_visit_');
            }

        }

        function createInputDiv(containerId, inputId, labelText, placeholderText, not_text=null, is_state=null, required=null) {
            const div = document.createElement('div');
            div.className = 'mb-3';
            div.id = containerId;

            const label = document.createElement('label');
            label.htmlFor = inputId;
            label.className = 'form-label eh-label';
            label.textContent = labelText;

            const input = document.createElement('input');
            if (required){
                input.required = true;
            }
            input.className = 'form-control dark-input';

            if (not_text == 'date') {
                input.type = 'date';
            } 
            else if(not_text == 'radio') {
                input.type = 'radio';
                input.className = 'form-check-input';                
            }
            else if(not_text == 'checkbox') {
                input.type = 'checkbox';
                input.className = 'form-check-input eh-checkbox me-3';
            }
            else if (not_text == 'number') {
                input.type = 'number';
            }
            else if (not_text == 'mobile_number') {
                input.type = 'number';
                input.setAttribute('max', '9999999999');
                input.setAttribute('maxlength', '10');
                input.setAttribute('min', '1000000000');
            }
            else {
                input.type = 'text';
            }
            // input.type = 'text';
            input.id = inputId;
            input.name = inputId;
            input.placeholder = placeholderText;
            if (is_state) {
                input.id = 'visit_state';
            }

            if(not_text == 'checkbox') {
                div.appendChild(input);
                div.appendChild(label);

            }

            else {
                div.appendChild(label);
                div.appendChild(input);
            }
            const suggestion_box = document.createElement('div');
            suggestion_box.id = containerId + '_suggestion_div';
            div.appendChild(suggestion_box)

            return div;
        }

        function deleteElementsWithIdPrefix(prefix) {
            const elements = document.querySelectorAll(`[id^="${prefix}"]`);
            elements.forEach(element => element.remove());
        }

        function createHospitalFormInput() {
            deleteElementsWithIdPrefix('type_visit_');
            const parentElement = document.getElementById('add_visit_form_inputs');
            parentElement.appendChild(createInputDiv('type_visit_hospital_hospital_name', 'hospital_hospital_name', 'Hospital Name', 'Enter Hospital Name', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_city', 'hospital_city', 'City', 'Enter City', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_state', 'hospital_state', 'State', 'Enter State', null, true, true));
            city_state_get_suggestions('hospital');
            parentElement.appendChild(createInputDiv('type_visit_hospital_doa', 'hospital_doa', 'Date of Admission', 'Enter Date of Admission', 'date', null, true));
            if (visit_type != 'CashlessClaimReport') {
            parentElement.appendChild(createInputDiv('type_visit_hospital_dod', 'hospital_dod', 'Date of Discharge', 'Enter Date of Discharge', 'date', null, true));
            }
            parentElement.appendChild(createInputDiv('type_visit_hospital_claim_value', 'hospital_claim_value', 'Claim Value', 'Enter Claim Value', 'number', null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_diagnosis', 'hospital_diagnosis', 'Diagnosis', 'Enter Diagnosis', null, null, true));
            get_suggestions();
            parentElement.appendChild(createInputDiv('type_visit_hospital_registration_number', 'hospital_registration_number', 'Registration Number', 'Enter Registration Number', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_no_of_beds', 'hospital_no_of_beds', 'No of Beds', 'Enter No of Beds', 'number', null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_icu', 'hospital_icu', 'ICU', 'Enter ICU', 'number', null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_ot', 'hospital_ot', 'OT', 'Enter OT', 'number', null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_nursing_staff', 'hospital_nursing_staff', 'Nursing staff', 'Enter Nursing staff', 'number', null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_rmo', 'hospital_rmo', 'RMO', 'Enter RMO', null, null, true));
            
            parentElement.appendChild(createInputDiv('type_visit_hospital_treating_doctor_degree', 'hospital_treating_doctor_degree', 'Treating Doctor Degree', 'Enter Treating Doctor Degree'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_treating_doctor_registration_number', 'hospital_treating_doctor_registration_number', 'Treating Doctor Registration Number', 'Enter Treating Doctor Registration Number'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_treating_doctor_contact_number', 'hospital_treating_doctor_contact_number', 'Treating Doctor Contact Number', 'Enter Treating Doctor Contact Number', 'mobile_number'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_treating_doctor_email', 'hospital_treating_doctor_email', 'Treating Doctor Email Id', 'Treating Doctor Enter Email Id'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_hospital_owner_name', 'hospital_hospital_owner_name', 'Hospital Owner Name', 'Enter Hospital Owner Name', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_hospital_owner_contact_number', 'hospital_hospital_owner_contact_number', 'Hospital Owner Contact Number', 'Enter Hospital Owner Contact Number', 'mobile_number', true, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_hospital_owner_registration_number', 'hospital_hospital_owner_registration_number', 'Hospital Owner Registration Number', 'Enter Hospital Owner Registration Number', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_hospital_anaesthetic_doctor_name', 'hospital_anaesthetic_doctor_name', 'Anaesthetic Doctor Name', 'Enter Anaesthetic Doctor Name'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_anaesthetic_doctor_registration_number', 'hospital_anaesthetic_doctor_registration_number', 'Anaesthetic Doctor Registration Number', 'Enter Anaesthetic Doctor Registration Number'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_anaesthetic_doctor_contact_details', 'hospital_anaesthetic_doctor_contact_details', 'Anaesthetic Doctor Contact Details', 'Enter Anaesthetic Doctor Contact Details', 'mobile_number'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_anaesthetic_doctor_email', 'hospital_anaesthetic_doctor_email', 'Anaesthetic Doctor Email', 'Enter Anaesthetic Doctor Email'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_family_physician_doctor_name', 'hospital_family_physician_doctor_name', 'Family Physician Doctor Name', 'Enter Family Physician Doctor Name'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_family_physician_registration_number', 'hospital_family_physician_registration_number', 'Family Physician Registration Number', 'Enter Family Physician Registration Number'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_family_physician_contact_details', 'hospital_family_physician_contact_details', 'Family Physician Contact Details', 'Enter Family Physician Contact Details', 'mobile_number'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_family_physician_email', 'hospital_family_physician_email', 'Family Physician Email', 'Enter Family Physician Email'));
            getQuestions('hospital');
            let h6_variable = document.createElement('label');
            h6_variable.id = "type_visit_h6_variable"
            h6_variable.className = 'form-label eh-label';
            h6_variable.textContent = 'Work Place Visit / Corporate Visit';
            parentElement.appendChild(h6_variable);

            parentElement.appendChild(createInputDiv('type_visit_hospital_work_place', 'hospital_work_place', 'Workplace', 'Enter Workplace', 'checkbox'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_corporate_visit', 'hospital_corporate_visit', 'Corporate Visit', 'Enter Corporate Visit', 'checkbox'));
            parentElement.appendChild(createInputDiv('type_visit_hospital_tat', 'hospital_tat', 'TAT', 'Enter TAT', 'number', null, true));
            handle_visit_state();
        }

        function createLabFormInput() {
            deleteElementsWithIdPrefix('type_visit_');
            const parentElement = document.getElementById('add_visit_form_inputs');
            parentElement.appendChild(createInputDiv('type_visit_lab_name', 'lab_name', 'Name', 'Enter Name', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_lab_city', 'lab_city', 'City', 'Enter City', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_lab_state', 'lab_state', 'State', 'Enter State', null, true, true));
            city_state_get_suggestions('lab');
            parentElement.appendChild(createInputDiv('type_visit_lab_address', 'lab_address', 'Address', 'Enter Address', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_lab_pathologist_name', 'lab_pathologist_name', 'Pathologist Name', 'Enter Pathologist Name'));
            parentElement.appendChild(createInputDiv('type_visit_lab_registration_number', 'lab_registration_number', 'Registration Number', 'Enter Registration Number'));
            parentElement.appendChild(createInputDiv('type_visit_lab_tat', 'lab_tat', 'TAT', 'Enter TAT', 'number', null, true));
            getQuestions('lab');
            handle_visit_state();
        }

        function createChemistFormInput() {
            deleteElementsWithIdPrefix('type_visit_');
            const parentElement = document.getElementById('add_visit_form_inputs');
            parentElement.appendChild(createInputDiv('type_visit_chemist_name_of_chemist', 'chemist_name_of_chemist', 'Name of Chemist', 'Enter Name of Chemist', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_chemist_address', 'chemist_address', 'Address', 'Enter Address', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_chemist_city', 'chemist_city', 'City', 'Enter City', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_chemist_state', 'chemist_state', 'State', 'Enter State', null, true, true));
            city_state_get_suggestions('chemist');
            parentElement.appendChild(createInputDiv('type_visit_chemist_gst_number', 'chemist_gst_number', 'GST Number', 'Enter GST Number'));
            parentElement.appendChild(createInputDiv('type_visit_chemist_drug_license_number', 'chemist_drug_license_number', 'Drug Licence Number', 'Enter Drug Licence Number'));
            parentElement.appendChild(createInputDiv('type_visit_chemist_tat', 'chemist_tat', 'TAT', 'Enter TAT', 'number', null, true));
            getQuestions('chemist');
            handle_visit_state();
        }

        function createInsuredFormInput() {
            deleteElementsWithIdPrefix('type_visit_');
            const parentElement = document.getElementById('add_visit_form_inputs');
            parentElement.appendChild(createInputDiv('type_visit_insured_name', 'insured_name', 'Name', 'Enter Name', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_insured_age', 'insured_age', 'Age', 'Enter Age', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_insured_contact_number', 'insured_contact_number', 'Contact Number', 'Enter Contact Number', 'mobile_number', null, true));
            parentElement.appendChild(createInputDiv('type_visit_insured_address', 'insured_address', 'Address', 'Enter Address', null, null, true));
            parentElement.appendChild(createInputDiv('type_visit_insured_city', 'insured_city', 'City', 'Enter City'));
            parentElement.appendChild(createInputDiv('type_visit_insured_state', 'insured_state', 'State', 'Enter State', null, true, true));
            city_state_get_suggestions('insured');
            parentElement.appendChild(createInputDiv('type_visit_insured_tat', 'insured_tat', 'TAT', 'Enter TAT', 'number', null, true));
            getQuestions('insured');
            handle_visit_state();
        }

        function handle_visit_state() {
            document.getElementById('visit_state').addEventListener('change', function() {
                const state = this.value;
                getInvestigatorDetails(state);
                console.log('erh reshaha reahrea');
            });
        }

        function toggleAddQuestions() {
            let question_list = document.getElementById('questions-list');

            if (question_list.style.display == 'none') {
                question_list.style.display = 'block';
                document.getElementById('add-question-icon').classList.remove('fa-chevron-down');
                document.getElementById('add-question-icon').classList.add('fa-chevron-up');
            }
            else {
                question_list.style.display = 'none';
                document.getElementById('add-question-icon').classList.remove('fa-chevron-up');
                document.getElementById('add-question-icon').classList.add('fa-chevron-down');
            }
        }

        function generateQuestions(questions) {
            const container = document.getElementById('questions-list'); // Create a container for the checkboxes
            questions.forEach((question, index) => {
                const questionNumber = index + 1; // Calculate the question number

                // Create the outer div with class "form-check"
                const div = document.createElement('div');
                div.className = 'form-check';
                div.id = `visit_question_div${questionNumber}`;

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.className = 'form-check-input eh-checkbox';
                input.id = `visit_question${questionNumber}`;
                input.name = `question${question.id}`;
                input.value = question.id;

                const label = document.createElement('label');
                label.className = 'form-check-label ms-2';
                label.setAttribute('for', `visit_question${questionNumber}`);
                label.textContent = question.question;

                div.appendChild(input);
                div.appendChild(label);

                container.appendChild(div);

                const hr = document.createElement('hr');
                hr.className = 'my-2';
                container.appendChild(hr);
            });
            setFormValues(visit_edit_data);
        }

        function viewQuestions(questions) {
            let question_list = document.getElementById(`${questions.id}-list`);

            if (question_list.style.display == 'none') {
                question_list.style.display = 'block';
                document.getElementById(`${questions.id}-icon`).classList.remove('fa-chevron-down');
                document.getElementById(`${questions.id}-icon`).classList.add('fa-chevron-up');
            }
            else {
                question_list.style.display = 'none';
                document.getElementById(`${questions.id}-icon`).classList.remove('fa-chevron-up');
                document.getElementById(`${questions.id}-icon`).classList.add('fa-chevron-down');
            }
        }

        function createVisitCard(type_of_visit, cardId, visitNumber, details, questions, visit_id, visit) {
            // Create the outer card container
            if (!visit.visit_completed) {
                document.getElementById('send_case_to_medical_officer').setAttribute('onclick', "updateCaseStatus('Medical', true)")
            }
            else {
                if (visit.visit_cost=='') {
                    document.getElementById('send_case_to_medical_officer').setAttribute('onclick', "askToAddCost()")
                }
            }

            const card = document.createElement('div');
            card.className = 'p-3 mt-3 visit-card px-0 pe-3';

            // Create the header section
            const header = document.createElement('div');
            header.className = 'd-flex';
            header.id = `card-${cardId}`;
            header.setAttribute('onclick', 'toggleCard(this)');
            header.style.cursor = 'pointer';

            if (visit.issue_in_investigation) {
                const headerIcon = document.createElement('div');
                headerIcon.className = 'col-2 text-center';
                const headerIconI = document.createElement('i');
                headerIconI.className = 'fa fa-triangle-exclamation fa-xl';
                headerIcon.appendChild(headerIconI);
                card.style.backgroundColor = '#ff00002b';
                header.appendChild(headerIcon);
            }
            else {
                const headerIcon = document.createElement('div');
                const headerIconI = document.createElement('i');

                if (visit.visit_completed) {                    
                    headerIcon.className = 'col-2 text-center';                    
                    headerIconI.className = 'fa fa-check fa-xl';                    
                }

                else if (visit.investigation_started == true && visit.visit_completed == false) {                    
                    headerIcon.className = 'col-2 text-center';                    
                    headerIconI.className = 'fa fa-hourglass fa-xl';
                }
    
                else{                    
                    headerIcon.className = 'col-2 text-center';                    
                    headerIconI.className = 'fa fa-stopwatch fa-xl';
                }
                headerIcon.appendChild(headerIconI);
                header.appendChild(headerIcon);
    

            }

            // Header - Left side (Visit Number)
            const headerLeft = document.createElement('div');
            headerLeft.className = 'col-8 text-start';
            const title = document.createElement('h5');
            title.className = 'm-0';
            // title.textContent = `Visit Number ${visitNumber}`;
            title.textContent = `${type_of_visit} Visit`;
            headerLeft.appendChild(title);

            // Header - Right side (Toggle Icon)
            const headerRight = document.createElement('div');
            headerRight.className = 'col text-end';
            const icon = document.createElement('i');
            icon.className = 'fa fa-plus';
            icon.id = `card-${cardId}-icon`;
            headerRight.appendChild(icon);

            // Append header left and right to the header
            header.appendChild(headerLeft);
            header.appendChild(headerRight);

            // Create the details section
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'px-3 pe-0';
            // detailsDiv.className = 'wow animate__animated animate__fadeInDown';
            // detailsDiv.setAttribute('data-wow-duration', '0.2s');
            detailsDiv.style.display = 'none';
            detailsDiv.id = `card-${cardId}-detail`;

            // Add a horizontal line
            const hr = document.createElement('hr');
            detailsDiv.appendChild(hr);

            // Create the details content
            const detailsRow = document.createElement('div');
            detailsRow.className = 'row';

            // Edit and Delete icons
            const actionCol = document.createElement('div');
            actionCol.className = 'col-12 text-end mb-3';
            const editIcon = document.createElement('i');
            editIcon.className = 'fa fa-pen fa-lg eh-text-blue-primary';
            editIcon.setAttribute('onclick', `editVisitDetail('${visit_id}');`);
            const deleteIcon = document.createElement('i');
            deleteIcon.className = 'fa fa-trash fa-lg text-danger';
            deleteIcon.setAttribute('onclick', `deleteVisitDetail('${visit_id}');`);
            actionCol.appendChild(editIcon);
            actionCol.innerHTML += '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
            actionCol.appendChild(deleteIcon);
            detailsRow.appendChild(actionCol);

            if (visit.issue_in_investigation) {
                const issueCol = document.createElement('div');
                issueCol.className = 'col-6 text-start eh-key';
                issueCol.textContent = 'Investigator Issue';

                // Value column
                const reasonCol = document.createElement('div');
                reasonCol.className = 'col-6 text-end text-lg-start text-break eh-value';
                reasonCol.textContent = visit.issue_of_investigator;

                // Append key and value columns
                detailsRow.appendChild(issueCol);
                detailsRow.appendChild(reasonCol);

                // Add a horizontal line after each detail
                const detailHrDiv = document.createElement('div');
                detailHrDiv.className = 'col-12 px-3';
                const detailHr = document.createElement('hr');
                detailHr.className = 'p-0 my-1 visit-card-eh-hr';
                detailHrDiv.appendChild(detailHr);
                detailsRow.appendChild(detailHrDiv);
            }
            // Add each key-value pair to the details
            for (const [key, value] of Object.entries(details)) {
                // Key column
                const keyCol = document.createElement('div');
                keyCol.className = 'col-6 text-start eh-key';
                keyCol.textContent = key;

                // Value column
                const valueCol = document.createElement('div');
                valueCol.className = 'col-6 text-end text-lg-start text-break eh-value';
                if (key=='Corporate Visit' || key=='Work Place') {
                    if (value) {
                        valueCol.textContent = 'Yes';
                    }
                    else {
                        valueCol.textContent = 'No';
                    }
                }
                else {
                    valueCol.textContent = value;
                }

                // Append key and value columns
                detailsRow.appendChild(keyCol);
                detailsRow.appendChild(valueCol);

                // Add a horizontal line after each detail
                const detailHrDiv = document.createElement('div');
                detailHrDiv.className = 'col-12 px-3';
                const detailHr = document.createElement('hr');
                detailHr.className = 'p-0 my-1 visit-card-eh-hr';
                detailHrDiv.appendChild(detailHr);
                detailsRow.appendChild(detailHrDiv);
            }

            // Append the details row to the details div
            detailsDiv.appendChild(detailsRow);

            // Questions Section
            const questionsContainer = document.createElement('div');
            questionsContainer.className = 'col-12 mt-2';
            const questionCard = document.createElement('div');
            questionCard.className = 'select-question-card p-2';

            const questionHeader = document.createElement('div');
            questionHeader.className = 'd-flex';
            questionHeader.id = `visit${visitNumber}-questions`;
            questionHeader.style.cursor = 'pointer';
            questionHeader.setAttribute('onclick', 'viewQuestions(this)');

            const questionHeaderLeft = document.createElement('div');
            questionHeaderLeft.className = 'col text-start';
            const questionLabel = document.createElement('label');
            questionLabel.className = 'form-label eh-label m-0';
            questionLabel.textContent = 'Questions';
            questionHeaderLeft.appendChild(questionLabel);

            const questionHeaderRight = document.createElement('div');
            questionHeaderRight.className = 'col text-end';
            const questionIcon = document.createElement('i');
            questionIcon.className = 'fa fa-chevron-down';
            questionIcon.id = `visit${visitNumber}-questions-icon`;
            questionHeaderRight.appendChild(questionIcon);

            questionHeader.appendChild(questionHeaderLeft);
            questionHeader.appendChild(questionHeaderRight);

            const questionList = document.createElement('div');
            questionList.id = `visit${visitNumber}-questions-list`;
            questionList.className = 'mt-4';
            questionList.style.display = 'none';

            // Add individual questions
            questions.forEach((question, index) => {
                // const questionItem = document.createElement('div');
                // questionItem.className = 'p-2 py-0';

                // const questionLabel = document.createElement('label');
                // questionLabel.className = 'form-label eh-label m-0';
                // questionLabel.innerHTML = `<b>Q${index + 1})</b> ${question}`;

                // const hr = document.createElement('hr');
                // hr.className = 'm-1';

                // questionItem.appendChild(questionLabel);
                // questionItem.appendChild(hr);

                // New code for answers in visit card
                // Create the main card div
                const questionItem = document.createElement('div');
                questionItem.classList.add('p-3', 'my-2', 'question-card');

                // Create the question label
                const questionLabel = document.createElement('label');
                questionLabel.classList.add('form-label', 'eh-label', 'm-0');
                questionLabel.innerHTML = `<b>Q${index + 1})</b> ${question.question}`;

                // Create the horizontal line
                const hr = document.createElement('hr');
                hr.classList.add('m-1');

                // Create the answer label
                const answerLabel = document.createElement('label');
                if (question.answer === false) {
                    answerLabel.classList.add('form-label', 'm-0', 'text-danger');
                    answerLabel.innerHTML = `<b>A${index + 1}) Not Yet Answered</b>`;    
                }
                else {
                    answerLabel.classList.add('form-label', 'm-0');
                    answerLabel.innerHTML = `<b>A${index + 1})</b> ${question.answer}`;
                }

                // Append children to the card
                questionItem.appendChild(questionLabel);
                questionItem.appendChild(hr);
                questionItem.appendChild(answerLabel);


                questionList.appendChild(questionItem);
            });

            questionCard.appendChild(questionHeader);
            questionCard.appendChild(questionList);
            questionsContainer.appendChild(questionCard);

            detailsRow.appendChild(questionsContainer);

            // Append the header and details section to the card
            card.appendChild(header);

            if (visit.visit_cost=='') {
                const addCost = document.createElement('div');
                addCost.className = 'col-12 mt-4';

                const addCostLabel = document.createElement('h5');
                addCostLabel.className = 'form-label eh-label';
                addCostLabel.textContent = 'Add Visit Cost';
                addCostLabel.htmlFor = 'visit_cost';
                addCost.appendChild(addCostLabel);

                const addCostInput = document.createElement('input');
                addCostInput.className = 'form-control dark-input';
                addCostInput.placeholder = 'Enter Visit Cost';
                addCostInput.id = 'visit_cost';
                addCostInput.name = 'visit_cost';
                addCostInput.type = 'number';
                addCostInput.required = true;
                addCost.appendChild(addCostInput);

                const addCostButton = document.createElement('button');
                addCostButton.className = 'btn btn-primary eh-btn-blue-primary w-100 mt-3';
                addCostButton.textContent = 'Add Cost';
                addCostButton.setAttribute('onclick', `addVisitCost('${visit_id}')`);
                addCost.appendChild(addCostButton);

                detailsDiv.appendChild(addCost);
            }

            card.appendChild(detailsDiv);

            return card;
        }

        // All Visit related api caller
        async function getVistDetails() {
            const Params = {
                case_id: caseId,
            };

            const url = "{% url 'visit-api-list' %}?" + toQueryString(Params);
            const [success, result] = await callApi("GET", url);
            console.log(result);
            if (success) {
                if (result.success) {
                    if (!result.no_visit_for_case){
                        result.data.forEach((visit, index) => {
                            document.getElementById('no-visit-created').style.display = 'none';
                            console.log(visit);
                            console.log(visit.visit_id);
                            let question_lst = getQuestionAnsersForVisit(visit.visit_id).then((question_lst) => {
                                console.log(question_lst)
                                const visit_card = createVisitCard(visit.type_of_visit, index, index, visit.final_card_data, question_lst, visit.visit_id, visit);
                                document.getElementById('visit-cards').appendChild(visit_card);
                            }).catch((error) => {
                                console.error("An error occurred:", error);
                            });
                            
                        });
                    }
                }
                else {
                    // window.location.href=`{% url 'dashboard-list' %}`;
                }
            } else {
                // window.location.href=`{% url 'dashboard-list' %}`;
            }
        }

        async function getQuestionAnsersForVisit(visit_id) {
            const Params = {
                visit_id: visit_id
            };

            const url = "{% url 'visit-question-api-list' %}?" + toQueryString(Params); // Construct the full URL with query params
            const [success, result] = await callApi("GET", url);
            if (success) {
                if (result.success) {
                    return result.data;
                }

                else {
                    return [];
                }

            } else {
                console.error("GET User Failed:", result);
            }
        }


        async function getInvestigatorDetails(state=null) {
            deleteElementsWithIdPrefix('investigator_officer_option_');
            const Params = {
                user_role: "investigator",
            };

            if (state != null) {
                Params['state'] = state;
            }

            const url = "{% url 'list_users_by_role-list' %}?" + toQueryString(Params); // Construct the full URL with query params
            const [success, result] = await callApi("GET", url);
            if (success) {
                console.log("GET User Success:", result);
                const selectElement = document.getElementById('investigator_select');

                // Loop through the list of dictionaries
                result.data.users.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.user_id;  // Set the value from the dictionary
                    option.textContent = item.name;  // Set the text from the dictionary
                    option.id = `investigator_officer_option_${item.user_id}`;
                    selectElement.appendChild(option);  // Append the option to the select element
                });

            } else {
                console.error("GET User Failed:", result);
            }
        }

        async function getQuestions(type_of_visit) {
            deleteElementsWithIdPrefix('visit_question_div');
            let Params = {
                type_of_visit: type_of_visit
            }
            const url = "{% url 'question-api-list' %}?" + toQueryString(Params);;
            const [success, result] = await callApi("GET", url);
            console.log(result);
            if (success) {
                if (result.success) {
                    console.log(result.data);
                    console.log('eahtngriob  gtyrhograbghtubrhubt gubhugt');
                    generateQuestions(result.data)
                }
                else {
                    // window.location.href=`{% url 'dashboard-list' %}`;
                }
            } else {
                // window.location.href=`{% url 'dashboard-list' %}`;
            }
        }

        function getSelectedVisitQuestions() {
            const checkboxes = document.querySelectorAll("input[type='checkbox'][id^='visit_question']");
            const selectedValues = [];
            checkboxes.forEach((checkbox) => {
                if (checkbox.checked) {
                    selectedValues.push(checkbox.value);
                }
            });            
            return selectedValues;
        }

        async function createNewVisit() {
            if (document.getElementById('edit_visit_id').value == ''){
                let new_visit_detail = {
                    'case_id': caseId
                }
                var form_new_visit = new FormData(document.getElementById('add_visit_form'));
                form_new_visit.forEach((value, key) => {
                    if (!Object.prototype.hasOwnProperty.call(new_visit_detail, key)) {
                        new_visit_detail[key] = value;
                        return;
                    }
                    if (!Array.isArray(new_visit_detail[key])) {
                        new_visit_detail[key] = [new_visit_detail[key]];
                    }
                    new_visit_detail[key].push(value);
                });
    
                new_visit_detail['questions'] = getSelectedVisitQuestions();
                console.log(new_visit_detail);
    
                showModal(
                'Confirm Action',
                '<p>Are you sure you want to create visit?</p>',
                async () => {
                    const bodyData = new_visit_detail;
        
                    const url = "{% url 'visit-api-list' %}";
                    const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");
                    if (success) {
                        window.location.href=`{% url 'case_overview-list' %}?case_id=${caseId}&visit_tab=true`;
                    } else {
                        alert('Unable to create new visit`');
                    }
                    }
                );
            }

            else {
                updateVisit();
            }
        }
        let visit_edit_data = ''
        async function editVisitDetail(visit_id) {
            const Params = {
                visit_id: visit_id,
            };

            const url = "{% url 'visit-details-api-list' %}?" + toQueryString(Params);
            const [success, result] = await callApi("GET", url);
            console.log(result);
            if (success) {
                if (result.success) {
                    uncheckQuestions();
                    handleEditVisitModal(result.data.type_of_visit);
                    setFormValues(result.data);
                    visit_edit_data = result.data;
                    setFormValues(result.data);
                    if (document.getElementById('type_visit_insured_address')) {                        
                        document.querySelectorAll('input[type="text"][name^="insured_name"]')[1].value = result.data.insured_name;
                        document.querySelectorAll('input[type="text"][name^="insured_address"]')[1].value = result.data.insured_address;                        
                    }
                }
                else {
                    window.location.href=`{% url 'dashboard-list' %}`;
                }
            } else {
                window.location.href=`{% url 'dashboard-list' %}`;
            }
        }

        async function deleteVisitDetail(visit_id) {
            const bodyData = {
                visit_id: visit_id,
            };

            const url = "{% url 'delete-visit-api-list' %}?";
            const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");
            console.log(result);
            if (success) {
                if (result.success) {
                    showSimpleModal('Visit Deleted', 'The visit has been deleted successfully');
                }
                else {
                    // window.location.href=`{% url 'dashboard-list' %}`;
                }
            } else {
                // window.location.href=`{% url 'dashboard-list' %}`;
            }
        }

        function handleEditVisitModal(type_of_visit){
            document.getElementById('addVisitBtn').click();
            document.getElementById('type_of_visit').value = type_of_visit;
            handleOptionChange();
            document.getElementById('type_of_visit').disabled = true;
        }

        function defaultVisitModal(){
            document.getElementById('type_of_visit').value = 'default';
            handleOptionChange();
            document.getElementById('edit_visit_id').value = '';
            document.getElementById('investigator_select').value = '';
            document.getElementById('type_of_visit').disabled = false;
            document.getElementById('addVisitBtnModal').click();
            uncheckQuestions();

        }

        function uncheckQuestions() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][name^="question"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        async function updateVisit() {
            visit_id = document.getElementById('edit_visit_id').value
            let update_visit_detail = {
                'visit_id': visit_id
            }

            var form_new_visit = new FormData(document.getElementById('add_visit_form'));
            form_new_visit.forEach((value, key) => {
                if (!Object.prototype.hasOwnProperty.call(update_visit_detail, key)) {
                    update_visit_detail[key] = value;
                    return;
                }
                if (!Array.isArray(update_visit_detail[key])) {
                    update_visit_detail[key] = [update_visit_detail[key]];
                }
                update_visit_detail[key].push(value);
            });

            update_visit_detail['type_of_visit'] = document.getElementById('type_of_visit').value;

            update_visit_detail['questions'] = getSelectedVisitQuestions();
            console.log(update_visit_detail);

            showModal(
                'Confirm Action',
                '<p>Are you sure you want to update visit?</p>',
                async () => {
                    const bodyData = update_visit_detail;

                    const url = "{% url 'update-visit-api-list' %}";
                    const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");
                    console.log(result);
                    if (success) {
                        window.location.href=`{% url 'case_overview-list' %}?case_id=${caseId}&visit_tab=true`;
                    } else {
                        alert('Unable to save the visit details');
                    }
                }
            );
        }

        async function addVisitCost(visit_id) {
            toggle_loader();
            let visit_cost = document.getElementById('visit_cost').value;            
            if (visit_cost === "") {
                toggle_loader();
                alert("Please enter visit cost");
                return;
            }
            
            console.log(visit_cost)
            const bodyData = {
                visit_id: visit_id,
                visit_cost: visit_cost
            };

            const url = "{% url 'add-visit-cost-api-list' %}";
            const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");
            if (success) {
                if (result.success) {
                    toggle_loader();
                    window.location.href=`{% url 'case_overview-list' %}?case_id=${caseId}&visit_tab=true`;
                } else {
                    console.error("Failed:", result);
                    toggle_loader();
                    alert("Unable to add visit cost");
                }
            } else {
                console.error("Failed:", result);
                toggle_loader();
                alert("Unable to add visit cost");

            }

        }

    </script>

    <script>
        // Handle document section

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        function openDocModal(doc_path, doc_name) {
            displayDocument(doc_path);
            document.getElementById('viewDocumentModalLabel').innerText = doc_name;
            const myModal = new bootstrap.Modal(document.getElementById('viewDocumentModal'));
            myModal.show();
        }

        function createDocumentList(documentList) {
            const container = document.getElementById('document_list_div');

            documentList.forEach((docItem) => {
                const documentDiv = document.createElement('div');
                documentDiv.className = 'd-flex align-items-center py-3 px-2 mb-2 document-card';
                documentDiv.setAttribute('onclick', `openDocModal('${docItem.path}','${docItem.name}')`);

                const icon = document.createElement('i');
                icon.className = 'fa fa-file-pdf fa-xl';

                const documentName = document.createElement('u');
                documentName.className = 'text-break';
                documentName.textContent = docItem.name;

                const nameContainer = document.createElement('div');
                nameContainer.appendChild(icon);
                nameContainer.appendChild(document.createTextNode('\u00A0\u00A0\u00A0')); // Adding spaces
                nameContainer.appendChild(documentName);

                const downloadDiv = document.createElement('div');
                downloadDiv.className = 'ms-auto';

                const downloadIcon = document.createElement('a');
                downloadIcon.href = docItem.path;
                downloadIcon.download = docItem.name;
                downloadIcon.className = 'fa fa-download fa-xl mx-2 text-black';
                downloadIcon.addEventListener('click', (event) => {
                    event.stopPropagation();
                });

                downloadDiv.appendChild(downloadIcon);

                documentDiv.appendChild(nameContainer);
                documentDiv.appendChild(downloadDiv);

                container.appendChild(documentDiv);
            });
        }

        function loadPDF(docPath) {
            const pdfRenderer = document.getElementById('pdf-renderer');
            const canvasContext = pdfRenderer.getContext('2d');

            // Load the PDF document
            pdfjsLib.getDocument(docPath).promise.then((pdf) => {
                // Load the first page of the PDF
                pdf.getPage(1).then((page) => {
                    const viewport = page.getViewport({ scale: 0.5 });

                    // Adjust canvas dimensions
                    pdfRenderer.width = viewport.width;
                    pdfRenderer.height = viewport.height;

                    // Render the PDF page into the canvas context
                    page.render({
                        canvasContext: canvasContext,
                        viewport: viewport,
                    });
                });
            }).catch((error) => {
                console.error('Error rendering PDF:', error);
            });
        }

        document.getElementById('addDocumentInput').addEventListener('change',async function (event) {
            const allowedExtensions = ['mp3', 'wav', 'ogg', 'mp4', 'webm', 'jpg', 'jpeg', 'png', 'gif', 'webp', 'pdf'];
            const file = event.target.files[0];
            console.log(file)

            if (file) {
                toggle_loader();
                const fileExtension = file.name.split('.').pop().toLowerCase();

                if (!allowedExtensions.includes(fileExtension)) {
                    alert(`Unsupported file type: ${file.name}`);
                    // Clear the input if invalid file is uploaded
                    event.target.value = '';
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                const bodyData = formData;
                formData.append('case_id', caseId);
            
                const url = "{% url 'add-case-document-api-list' %}";
                const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}", true);
                console.log(result);
                if (success) {
                    let case_id = result.data.case_id;
                    window.location.href=`{% url 'case_overview-list' %}?case_id=${case_id}&document_tab=true`;
                } else {
                }
                toggle_loader();

            }
        });

    </script>

    <script>
        async function updateCaseStatus(status, move_forward=false) {
            let pop_up_text = 'Hey {{user.name}}, this is not quality work to opt for edit option, Inspite of multiple reminders. This is being recorded in your performance.';
            if (status != 'Creation_confirmation'){
                pop_up_text = 'Are you sure you want to continue?';                
            }
            if (move_forward) {                
                showModal(
                'Action Denied',
                `<p>Hey {{user.name}}, Field Officer is still on job and all documents are still awaited. So don’t send case to Medical Officer</p>`,
                async () => {
                    console.log('debugger');
                },
                true
            );

            }
            else {
                showModal(
                    'Confirm Action',
                    `<p>${pop_up_text}</p>`,
                    async () => {
                        const Params = {
                            case_id: caseId,
                            case_status: status
                        };
            
                        const url = "{% url 'set-status-api-list' %}?" + toQueryString(Params);
                        const [success, result] = await callApi("GET", url);
                        console.log(result);
                        if (success) {
                            if (result.success) {                
                                    console.log(result.data);
                                    location.reload();
                            }
                            else {
                                window.location.href=`{% url 'dashboard-list' %}`;
                            }
                        } else {
                            window.location.href=`{% url 'dashboard-list' %}`;
                        }
                        
                    }
                );
                
            }    
        }

        async function askToAddCost() {         
            showModal(
                'Action Denied',
                `<p>Hey {{user.name}}, please fill cost of the visit before sending case to Medical Officer</p>`,
                async () => {
                    console.log('debugger');
                },
                true
            );            
        }

    </script>

    <script>
        function get_suggestions() {
            let inputField = document.getElementById("hospital_diagnosis");
            const debounce = (func, delay) => {
                let timer;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => func(...args), delay);
                };
            };

            inputField.addEventListener("input", debounce((e) => {
                const query = e.target.value.trim();
                fetchSuggestions(query);
            }, 300));

            inputField.addEventListener("blur", () => {
                setTimeout(() => {
                    suggestionBox.style.display = "none";
                }, 200); // Slight delay to allow click on suggestions
            });
            let = suggestionBox = document.getElementById('type_visit_hospital_diagnosis_suggestion_div');
            // suggestionBox.style.position = "absolute";
            suggestionBox.style.border = "1px solid #ccc";
            suggestionBox.style.background = "#fff";
            suggestionBox.style.zIndex = "1000";
            suggestionBox.style.display = "none";
            // document.getElementById('type_visit_hospital_diagnosis').appendChild(suggestionBox);
        }
        
        async function fetchSuggestions(query) {
            try {
                const bodyData = {
                    query_name: query,
                };

                const url = "{% url 'get-diagnosis-data-api-list' %}?";
                const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");
                if (success) {
                    if (result.success) {
                        console.log(result.data.suggestions);
                        showSuggestions(result.data.suggestions);
                    }
                }                
            } catch (error) {
                console.error("Error fetching suggestions:", error);
            }
        }

        function showSuggestions(names) {
            let inputField = document.getElementById("hospital_diagnosis");
            let = suggestionBox = document.getElementById('type_visit_hospital_diagnosis_suggestion_div');
            suggestionBox.innerHTML = "";
            if (names.length > 0) {
                names.forEach(name => {
                    const option = document.createElement("div");
                    option.textContent = name;
                    option.style.padding = "8px";
                    option.style.cursor = "pointer";
                    option.addEventListener("click", () => {
                        inputField.value = name;
                        suggestionBox.style.display = "none";
                    });
                    suggestionBox.appendChild(option);
                });
                const rect = inputField.getBoundingClientRect();
                suggestionBox.style.left = `${rect.left}px`;
                suggestionBox.style.top = `${rect.bottom}px`;
                suggestionBox.style.width = `${rect.width}px`;
                suggestionBox.style.display = "block";
            } else {
                suggestionBox.style.display = "none";
            }
        }

        

    </script>

    <script>
        function city_state_get_suggestions(type_of_visit) {
            let inputField = document.getElementById(`${type_of_visit}_city`);
            const debounce = (func, delay) => {
                let timer;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => func(...args), delay);
                };
            };

            inputField.addEventListener("input", debounce((e) => {
                const query = e.target.value.trim();
                city_state_fetchSuggestions(query, type_of_visit);
            }, 300));

            inputField.addEventListener("blur", () => {
                setTimeout(() => {
                    suggestionBox.style.display = "none";
                }, 200); // Slight delay to allow click on suggestions
            });
            let = suggestionBox = document.getElementById(`type_visit_${type_of_visit}_city_suggestion_div`);
            // suggestionBox.style.position = "absolute";
            suggestionBox.style.border = "1px solid #ccc";
            suggestionBox.style.background = "#fff";
            suggestionBox.style.zIndex = "1000";
            suggestionBox.style.display = "none";
        }

        async function city_state_fetchSuggestions(query, type_of_visit) {
            try {
                const bodyData = {
                    query_name: query,
                };

                const url = "{% url 'get-city-data-api-list' %}?";
                const [success, result] = await callApi("POST", url, bodyData, "{{csrf_token}}");
                if (success) {
                    if (result.success) {
                        console.log(result.data.city_data);
                        city_state_showSuggestions(result.data.city_data, type_of_visit);
                    }
                }                
            } catch (error) {
                console.error("Error fetching suggestions:", error);
            }
        }

        function city_state_showSuggestions(names, type_of_visit) {
            let inputField = document.getElementById(`${type_of_visit}_city`);
            let stateInputField = document.getElementById(`visit_state`);
            let = suggestionBox = document.getElementById(`type_visit_${type_of_visit}_city_suggestion_div`);
            suggestionBox.innerHTML = "";
            if (names.length > 0) {
                names.forEach(name => {
                    const option = document.createElement("div");
                    option.textContent = name.city;
                    option.style.padding = "8px";
                    option.style.cursor = "pointer";
                    option.addEventListener("click", () => {
                        inputField.value = name.city;
                        suggestionBox.style.display = "none";
                        stateInputField.value = name.state;
                        getInvestigatorDetails(name.state);
                    });
                    suggestionBox.appendChild(option);
                });
                const rect = inputField.getBoundingClientRect();
                suggestionBox.style.left = `${rect.left}px`;
                suggestionBox.style.top = `${rect.bottom}px`;
                suggestionBox.style.width = `${rect.width}px`;
                suggestionBox.style.display = "block";
            } else {
                suggestionBox.style.display = "none";
            }
        }

    </script>

</body>

</html>
